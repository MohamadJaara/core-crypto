name: publish kmp packages

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}-publish-kmp"

on:
  workflow_call:
    secrets:
      SONATYPE_USERNAME:
        required: true
      SONATYPE_PASSWORD:
        required: true
      PGP_KEY_ID:
        required: true
      PGP_SIGNING_KEY:
        required: true
      PGP_PASSPHRASE:
        required: true

env:
  CARGO_TERM_COLOR: always
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
  RELEASE: 1

jobs:
  publish-kmp:
    if: github.repository == 'MohamadJaara/core-crypto'
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v5
      - name: set up jdk 17
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: "adopt"
      - name: gradle setup
        uses: gradle/actions/setup-gradle@v4
      - name: validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4
      - name: setup android sdk
        uses: android-actions/setup-android@v3

      - name: install android ndk
        run: |
          sdkmanager --install "ndk;27.0.12077973"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV

      - name: install gnu sed (required for rust setup)
        run: brew install gnu-sed

      - name: setup rust toolchain
        uses: ./.github/actions/setup-and-cache-rust
        with:
          cache-key-prefix: kmp-all-targets
          rustflags: ""

      - name: install rust targets
        run: |
          # Android targets
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          # iOS targets
          rustup target add aarch64-apple-ios
          rustup target add aarch64-apple-ios-sim
          # macOS target (already available on macOS runner)
          rustup target add aarch64-apple-darwin

      - name: extract version from tag
        id: version
        run: |
          # Extract version from tag (removes 'v' prefix if present)
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: publish package
        working-directory: crypto-ffi/bindings/kmp
        run: |
          ./gradlew publishAllPublicationsToMavenCentralRepository --no-configuration-cache -PVERSION_NAME=${{ steps.version.outputs.VERSION }}
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.PGP_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.PGP_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.PGP_PASSPHRASE }}
