name: ðŸš€ publish kmp

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build without publishing)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
  RELEASE: 1

jobs:
  publish-kmp:
    name: Build and publish KMP
    runs-on: macos-14
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;27.0.12077973"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV

      - name: Install GNU sed (required for Rust setup)
        run: brew install gnu-sed

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-and-cache-rust
        with:
          cache-key-prefix: kmp-all-targets
          rustflags: ""

      - name: Install Rust targets
        run: |
          # Android targets
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          # iOS targets
          rustup target add aarch64-apple-ios
          rustup target add aarch64-apple-ios-sim
          # macOS target (already available on macOS runner)
          rustup target add aarch64-apple-darwin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Build KMP (dry run)
        if: ${{ inputs.dry_run == true }}
        working-directory: crypto-ffi/bindings/kmp
        run: |
          ./gradlew assemble --no-configuration-cache
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Publish KMP to Maven Central
        if: ${{ inputs.dry_run != true }}
        working-directory: crypto-ffi/bindings/kmp
        run: |
          ./gradlew publishAllPublicationsToMavenCentralRepository --no-configuration-cache
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.PGP_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.PGP_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.PGP_PASSPHRASE }}
