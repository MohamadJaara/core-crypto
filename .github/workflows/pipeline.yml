name: ðŸš€ pipeline

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:

env:
  CARGO_TERM_COLOR: always
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
  RELEASE: 1

jobs:
  #################
  # Publish

  prepare-publish:
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - uses: actions/checkout@v5

      - name: force-fetch the tag to work around actions/checkout#290
        run: git fetch -f origin ${{ github.ref }}:${{ github.ref }}

      - name: ensure the tag is signed
        run: git cat-file tag ${{ github.ref_name }} | grep -qE -- '-----BEGIN (PGP|SSH) SIGNATURE-----'

  publish-kmp:
    needs: prepare-publish
    uses: ./.github/workflows/publish-kmp.yml
    secrets:
      SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      PGP_KEY_ID: ${{ secrets.PGP_KEY_ID }}
      PGP_SIGNING_KEY: ${{ secrets.PGP_SIGNING_KEY }}
      PGP_PASSPHRASE: ${{ secrets.PGP_PASSPHRASE }}
